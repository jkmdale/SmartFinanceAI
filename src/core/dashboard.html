<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFinanceAI - Financial Dashboard</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/styles/main.css" as="style">
    <link rel="preload" href="/src/data/database-manager.js" as="script">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/dashboard.css">
    
    <!-- Security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;">
</head>
<body class="dashboard-page">
    <!-- Navigation -->
    <nav class="navbar glass">
        <div class="navbar-container">
            <div class="navbar-brand">
                <div class="navbar-logo">ğŸ§ </div>
                <span>SmartFinanceAI</span>
            </div>
            
            <ul class="navbar-nav desktop-nav">
                <li><a href="/dashboard" class="nav-link active">ğŸ“Š Dashboard</a></li>
                <li><a href="/accounts" class="nav-link">ğŸ¦ Accounts</a></li>
                <li><a href="/transactions" class="nav-link">ğŸ’³ Transactions</a></li>
                <li><a href="/budget" class="nav-link">ğŸ“ˆ Budget</a></li>
                <li><a href="/goals" class="nav-link">ğŸ¯ Goals</a></li>
                <li><a href="/reports" class="nav-link">ğŸ“Š Reports</a></li>
            </ul>
            
            <div class="navbar-actions">
                <button class="nav-action-btn" id="privacy-toggle" title="Toggle Privacy Mode">
                    ğŸ‘ï¸
                </button>
                <button class="nav-action-btn" id="notifications-btn" title="Notifications">
                    ğŸ””
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
                <div class="user-menu">
                    <button class="user-avatar" id="user-menu-toggle">
                        ğŸ‘¤
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href="/profile">ğŸ‘¤ Profile</a>
                        <a href="/settings">âš™ï¸ Settings</a>
                        <a href="/help">â“ Help</a>
                        <hr>
                        <a href="/logout">ğŸšª Sign Out</a>
                    </div>
                </div>
            </div>
            
            <!-- Mobile menu toggle -->
            <button class="mobile-nav-toggle" id="mobile-nav-toggle">
                â˜°
            </button>
        </div>
        
        <!-- Mobile navigation -->
        <ul class="navbar-nav mobile-nav" id="mobile-nav">
            <li><a href="/dashboard" class="nav-link active">ğŸ“Š Dashboard</a></li>
            <li><a href="/accounts" class="nav-link">ğŸ¦ Accounts</a></li>
            <li><a href="/transactions" class="nav-link">ğŸ’³ Transactions</a></li>
            <li><a href="/budget" class="nav-link">ğŸ“ˆ Budget</a></li>
            <li><a href="/goals" class="nav-link">ğŸ¯ Goals</a></li>
            <li><a href="/reports" class="nav-link">ğŸ“Š Reports</a></li>
        </ul>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Container -->
        <div id="dashboard-container" class="dashboard-container">
            <!-- Initial loading state -->
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <h2>Loading your financial dashboard...</h2>
                <p>Analyzing your accounts, transactions, and goals</p>
            </div>
        </div>
        
        <!-- Quick Actions Floating Menu -->
        <div class="quick-actions" id="quick-actions">
            <button class="quick-action-toggle" id="quick-action-toggle">
                â•
            </button>
            <div class="quick-action-menu" id="quick-action-menu">
                <button class="quick-action" onclick="window.location.href='/transactions/add'">
                    ğŸ’³ Add Transaction
                </button>
                <button class="quick-action" onclick="window.location.href='/accounts/create'">
                    ğŸ¦ Add Account
                </button>
                <button class="quick-action" onclick="window.location.href='/goals/create'">
                    ğŸ¯ Create Goal
                </button>
                <button class="quick-action" onclick="window.location.href='/csv-import'">
                    ğŸ“„ Import CSV
                </button>
            </div>
        </div>
    </main>
    
    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator" style="display: none;">
        <span class="offline-icon">âš ï¸</span>
        <span>You're offline. Data will sync when connection is restored.</span>
    </div>
    
    <!-- Loading Overlay for Sync -->
    <div id="sync-overlay" class="sync-overlay" style="display: none;">
        <div class="sync-content">
            <div class="sync-spinner"></div>
            <h3>Syncing your data...</h3>
            <p id="sync-status">Checking for updates</p>
        </div>
    </div>
    
    <!-- Core JavaScript Dependencies -->
    <script src="/src/data/database-manager.js"></script>
    <script src="/src/core/account-manager.js"></script>
    <script src="/src/core/dashboard-controller.js"></script>
    <script src="/src/global/localization.js"></script>
    <script src="/src/utils/currency-utils.js"></script>
    <script src="/src/utils/date-utils.js"></script>
    <script src="/src/platform/user-manager.js"></script>
    
    <!-- Dashboard Specific Scripts -->
    <script>
        /**
         * Dashboard Application Initialization
         */
        class DashboardApp {
            constructor() {
                this.isOnline = navigator.onLine;
                this.privacyMode = false;
                this.isInitialized = false;
            }
            
            async initialize() {
                try {
                    console.log('ğŸš€ Initializing SmartFinanceAI Dashboard...');
                    
                    // Check authentication
                    if (!this.checkAuthentication()) {
                        window.location.href = '/auth/login';
                        return;
                    }
                    
                    // Initialize service worker
                    await this.initializeServiceWorker();
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Initialize dashboard controller
                    await dashboardController.initialize();
                    
                    // Set up periodic sync
                    this.setupPeriodicSync();
                    
                    this.isInitialized = true;
                    console.log('âœ… Dashboard application initialized');
                    
                } catch (error) {
                    console.error('âŒ Dashboard initialization failed:', error);
                    this.showError('Failed to initialize dashboard. Please refresh the page.');
                }
            }
            
            checkAuthentication() {
                const session = sessionStorage.getItem('smartfinance_session');
                if (!session) {
                    return false;
                }
                
                try {
                    const sessionData = JSON.parse(session);
                    return sessionData.userId && sessionData.expiresAt > Date.now();
                } catch {
                    return false;
                }
            }
            
            async initializeServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/sw.js');
                        console.log('âœ… Service Worker registered:', registration);
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    this.showUpdateAvailable();
                                }
                            });
                        });
                        
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
            }
            
            setupEventListeners() {
                // Online/offline detection
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.hideOfflineIndicator();
                    this.syncData();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showOfflineIndicator();
                });
                
                // Privacy mode toggle
                document.getElementById('privacy-toggle')?.addEventListener('click', () => {
                    this.togglePrivacyMode();
                });
                
                // Mobile navigation
                document.getElementById('mobile-nav-toggle')?.addEventListener('click', () => {
                    this.toggleMobileNav();
                });
                
                // User menu
                document.getElementById('user-menu-toggle')?.addEventListener('click', () => {
                    this.toggleUserMenu();
                });
                
                // Quick actions
                document.getElementById('quick-action-toggle')?.addEventListener('click', () => {
                    this.toggleQuickActions();
                });
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.user-menu')) {
                        document.getElementById('user-dropdown').style.display = 'none';
                    }
                    if (!e.target.closest('.quick-actions')) {
                        document.getElementById('quick-action-menu').style.display = 'none';
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    this.handleKeyboardShortcuts(e);
                });
                
                // Page visibility for sync
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.isInitialized) {
                        this.syncData();
                    }
                });
            }
            
            togglePrivacyMode() {
                this.privacyMode = !this.privacyMode;
                const toggle = document.getElementById('privacy-toggle');
                
                if (this.privacyMode) {
                    document.body.classList.add('privacy-mode');
                    toggle.innerHTML = 'ğŸ™ˆ';
                    toggle.title = 'Show financial amounts';
                } else {
                    document.body.classList.remove('privacy-mode');
                    toggle.innerHTML = 'ğŸ‘ï¸';
                    toggle.title = 'Hide financial amounts';
                }
                
                localStorage.setItem('privacy_mode', this.privacyMode);
            }
            
            toggleMobileNav() {
                const mobileNav = document.getElementById('mobile-nav');
                const toggle = document.getElementById('mobile-nav-toggle');
                
                if (mobileNav.classList.contains('active')) {
                    mobileNav.classList.remove('active');
                    toggle.innerHTML = 'â˜°';
                } else {
                    mobileNav.classList.add('active');
                    toggle.innerHTML = 'âœ•';
                }
            }
            
            toggleUserMenu() {
                const dropdown = document.getElementById('user-dropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
            
            toggleQuickActions() {
                const menu = document.getElementById('quick-action-menu');
                const toggle = document.getElementById('quick-action-toggle');
                
                if (menu.style.display === 'block') {
                    menu.style.display = 'none';
                    toggle.innerHTML = 'â•';
                } else {
                    menu.style.display = 'block';
                    toggle.innerHTML = 'âœ•';
                }
            }
            
            handleKeyboardShortcuts(e) {
                // Ctrl/Cmd + combinations
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'r':
                            e.preventDefault();
                            dashboardController.refreshData();
                            break;
                        case 'h':
                            e.preventDefault();
                            this.togglePrivacyMode();
                            break;
                        case 'n':
                            e.preventDefault();
                            window.location.href = '/transactions/add';
                            break;
                    }
                }
                
                // Escape key
                if (e.key === 'Escape') {
                    document.getElementById('user-dropdown').style.display = 'none';
                    document.getElementById('quick-action-menu').style.display = 'none';
                    document.getElementById('mobile-nav').classList.remove('active');
                }
            }
            
            async syncData() {
                if (!this.isOnline || !this.isInitialized) return;
                
                try {
                    this.showSyncIndicator();
                    await dashboardController.refreshData(false);
                    this.hideSyncIndicator();
                } catch (error) {
                    console.error('Sync failed:', error);
                    this.hideSyncIndicator();
                }
            }
            
            setupPeriodicSync() {
                // Sync every 5 minutes when page is visible
                setInterval(() => {
                    if (!document.hidden && this.isOnline) {
                        this.syncData();
                    }
                }, 300000); // 5 minutes
            }
            
            showOfflineIndicator() {
                document.getElementById('offline-indicator').style.display = 'flex';
            }
            
            hideOfflineIndicator() {
                document.getElementById('offline-indicator').style.display = 'none';
            }
            
            showSyncIndicator() {
                document.getElementById('sync-overlay').style.display = 'flex';
            }
            
            hideSyncIndicator() {
                document.getElementById('sync-overlay').style.display = 'none';
            }
            
            showUpdateAvailable() {
                const notification = this.createNotification(
                    'App Update Available',
                    'A new version is ready. Refresh to update.',
                    'info',
                    [
                        {
                            text: 'Refresh',
                            action: () => window.location.reload()
                        },
                        {
                            text: 'Later',
                            action: () => {}
                        }
                    ]
                );
                
                document.getElementById('notification-container').appendChild(notification);
            }
            
            showError(message) {
                const notification = this.createNotification(
                    'Error',
                    message,
                    'error'
                );
                
                document.getElementById('notification-container').appendChild(notification);
            }
            
            createNotification(title, message, type = 'info', actions = null) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                
                const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
                
                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-header">
                            <span class="notification-icon">${icon}</span>
                            <span class="notification-title">${title}</span>
                            <button class="notification-close" onclick="this.closest('.notification').remove()">Ã—</button>
                        </div>
                        <div class="notification-message">${message}</div>
                        ${actions ? `
                            <div class="notification-actions">
                                ${actions.map(action => `
                                    <button class="notification-action" onclick="(${action.action})(); this.closest('.notification').remove();">
                                        ${action.text}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Auto-remove after 8 seconds if no actions
                if (!actions) {
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 8000);
                }
                
                return notification;
            }
        }
        
        // Initialize application
        const dashboardApp = new DashboardApp();
        
        // Start when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                dashboardApp.initialize();
            });
        } else {
            dashboardApp.initialize();
        }
        
        // Load privacy mode preference
        if (localStorage.getItem('privacy_mode') === 'true') {
            document.addEventListener('DOMContentLoaded', () => {
                dashboardApp.togglePrivacyMode();
            });
        }
        
        // Analytics tracking (placeholder)
        function trackEvent(category, action, label) {
            console.log('ğŸ“Š Analytics:', { category, action, label });
            // In production, send to analytics service
        }
        
        // Performance monitoring
        window.addEventListener('load', () => {
            // Track page load performance
            const perfData = performance.getEntriesByType('navigation')[0];
            console.log('âš¡ Page Load Performance:', {
                loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                firstPaint: performance.getEntriesByType('paint')[0]?.startTime
            });
        });
        
        console.log('âœ… Dashboard application script loaded!');
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>